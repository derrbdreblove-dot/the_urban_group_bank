{% extends "base.html" %}
{% block title %}Account Details - The Urban Group Bank{% endblock %}

{% block content %}
<div class="account-page">
  <section class="header-section">
    <img src="{{ url_for('static', filename='image/logo.png') }}" alt="The Urban Group Bank" class="page-logo">
    <h1>Account Details</h1>
    <p class="subtitle">View your personal and financial information securely</p>
    <a href="{{ url_for('dashboard') }}" class="btn-back">← Back to Dashboard</a>
  </section>

  <div class="account-wrapper">
    <!-- Account Info Card -->
    <div class="account-info-card">
      <h2>Account Information</h2>
      <div class="info-grid">
        <p><strong>Full Name:</strong> {{ user.full_name or user.get('fullname') or 'N/A' }}</p>
        <p><strong>Username:</strong> {{ user.username or 'N/A' }}</p>
        <p><strong>Email Address:</strong> {{ user.email or 'N/A' }}</p>
        <p><strong>Account Type:</strong> {{ user.account_type or 'Checking' }}</p>
        <p><strong>Account Number:</strong> {{ user.account_number or 'N/A' }}</p>
        <p><strong>Routing Number:</strong> {{ user.routing_number or 'N/A' }}</p>
        <p><strong>Date Joined:</strong> {{ user.date_joined or 'N/A' }}</p>
        <p><strong>Last Login:</strong> {{ user.last_login or 'N/A' }}</p>
        <p>
          <strong>Account Status:</strong>
          <span class="badge {{ 'active' if user.status == 'Active' else 'inactive' }}">{{ user.status or 'Active' }}</span>
        </p>
        <p>
          <strong>Client Tier:</strong>
          <span class="badge tier">{{ user.client_tier or 'Standard' }}</span>
        </p>
      </div>

      <div class="balance-section">
        <h3>Current Balance</h3>
        <p class="balance">${{ "{:,.2f}".format(user.balance or 0) }}</p>
      </div>
    </div>

    <!-- Platinum Card -->
    <div id="platinumCard" class="platinum-card">
      <div class="card-top">
        <div>
          <div class="bank-name">Urban Group Bank</div>
          <div class="muted small">Platinum — Visa</div>
        </div>

        <div class="d-flex align-items-center gap-3">
          <div class="card-chip"></div>
          <svg class="visa-logo" viewBox="0 0 48 17" xmlns="http://www.w3.org/2000/svg">
            <path d="M0 0h48v17H0z" fill="none"/>
            <path d="M7.1 11.7c.6.3 1.6.7 2.8.7 3 0 4.9-2 4.9-4.9 0-2.7-2.6-4.4-5.2-4.4-1.8 0-3 .5-3.9 1.1l.6 1.7c.6-.4 1.5-.9 3.1-.9 1.5 0 3.1.6 3.1 2.2.1 1.5-1.4 2.4-2.9 2.4-.8 0-1.4-.2-2-.5l-.5 1.6z" fill="#142688"/>
            <path d="M19.2 6.8h1.6l2.4 4.8h-1.9l-.4-1.1H20l-.4 1.1h-1.4l1.3-4.8zm1.6 2.7l-.7-1.9-.7 1.9h1.4z" fill="#142688"/>
            <path d="M31.2 6.8c1.1 0 1.9.6 2.3 1.5l.9-1.2c-.7-.7-1.7-1.2-3.1-1.2-2 0-3.5 1.1-3.5 2.8 0 1.9 1.6 2.7 2.9 3.2 1.3.5 1.8.9 1.8 1.6 0 .8-.8 1.4-2 1.4-1.4 0-2.4-.6-3.1-1.3l-.9 1.3c.9.9 2.3 1.7 4.4 1.7 2.6 0 4.3-1.2 4.3-3.1 0-1.6-1-2.6-2.9-3.2-1.2-.4-1.9-.7-1.9-1.4 0-.5.6-1.1 1.7-1.1z" fill="#142688"/>
          </svg>
        </div>
      </div>

      {% set card = user.card if user.card is defined else {'number':'0000000000000000','expiry':'MM/YY','cvv':'000'} %}
      {% set num = (card.number|string).replace(' ','') %}

      <div class="card-details">
        <div class="card-number" id="cardNumberDisplay">{{ num[:4] }} •••• •••• {{ num[-4:] }}</div>

        <div class="card-row">
          <div>
            <div class="card-small">Card Holder</div>
            <div class="fw-bold">{{ user.full_name or user.get('fullname') or user.username }}</div>
          </div>
          <div>
            <div class="card-small">Expires</div>
            <div class="fw-bold" id="expiryDisplay">{{ card.expiry }}</div>
          </div>
          <div>
            <div class="card-small">CVV</div>
            <div class="fw-bold" id="cvvMasked">•••</div>
          </div>
        </div>
      </div>

      <div class="card-actions">
        <button class="btn-card" id="revealCvvBtn">Reveal CVV</button>
        <button class="btn-card" id="copyCardBtn">Copy Number</button>
      </div>

      <p class="small muted text-center mt-2">Keep your card safe. Report immediately if lost or stolen.</p>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const cardEl = document.getElementById("platinumCard");
  if (cardEl) cardEl.classList.add("show");

  const revealBtn = document.getElementById("revealCvvBtn");
  const copyBtn = document.getElementById("copyCardBtn");
  const cvvEl = document.getElementById("cvvMasked");
  const cardNumberDisplay = document.getElementById("cardNumberDisplay");
  const expiryDisplay = document.getElementById("expiryDisplay");

  const rawNumber = "{{ (card.number|string)|e }}";
  const rawCvv = "{{ (card.cvv|string)|e }}";
  const rawExpiry = "{{ (card.expiry|string)|e }}";

  function maskedNumber(num) {
    const n = (num||"0000000000000000").replace(/\s+/g, '');
    if (n.length < 16) return n;
    return n.slice(0,4) + " •••• •••• " + n.slice(-4);
  }

  cardNumberDisplay.textContent = maskedNumber(rawNumber);
  expiryDisplay.textContent = rawExpiry || "MM/YY";
  cvvEl.textContent = "•••";

  let revealed = false;
  revealBtn.addEventListener("click", () => {
    if (!revealed) {
      const formatted = (rawNumber || "0000000000000000").match(/.{1,4}/g).join(" ");
      cardNumberDisplay.textContent = formatted;
      cvvEl.textContent = rawCvv || "000";
      revealBtn.textContent = "Hide CVV & Number";
      revealed = true;
    } else {
      cardNumberDisplay.textContent = maskedNumber(rawNumber);
      cvvEl.textContent = "•••";
      revealBtn.textContent = "Reveal CVV";
      revealed = false;
    }
  });

  copyBtn.addEventListener("click", async () => {
    const textToCopy = (rawNumber || "0000000000000000").match(/.{1,4}/g).join(" ");
    try {
      await navigator.clipboard.writeText(textToCopy);
      copyBtn.textContent = "Copied!";
      setTimeout(() => copyBtn.textContent = "Copy Number", 1200);
    } catch (e) {
      const ta = document.createElement("textarea");
      ta.value = textToCopy;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      copyBtn.textContent = "Copied!";
      setTimeout(() => copyBtn.textContent = "Copy Number", 1200);
    }
  });
});
</script>

{% endblock %}

{% block styles %}
<style>
.account-page {
  background: #f7faff;
  color: #0a2a43;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  padding: 40px 20px;
}
.header-section {
  text-align: center;
  margin-bottom: 30px;
}
.bank-logo {
  width: 120px;
  margin-bottom: 10px;
}
.subtitle {
  color: #6b7b8a;
  font-size: 15px;
  margin-bottom: 10px;
}
.btn-back {
  text-decoration: none;
  background: #0074cc;
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  font-weight: 500;
  transition: all 0.3s;
}
.btn-back:hover {
  background: #005fa3;
}
.account-wrapper {
  max-width: 1000px;
  margin: 0 auto;
}
.account-info-card {
  background: white;
  border-radius: 14px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  padding: 30px;
  margin-bottom: 25px;
}
.account-info-card h2 {
  margin-bottom: 20px;
  color: #0a2a43;
  font-weight: 600;
}
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 12px;
}
.balance-section {
  margin-top: 20px;
  text-align: center;
}
.balance {
  font-size: 1.8rem;
  font-weight: 700;
  color: #0074cc;
}
.badge {
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
}
.badge.active {
  background: #e0f7e9;
  color: #008e53;
}
.badge.inactive {
  background: #fde8e8;
  color: #d32f2f;
}
.badge.tier {
  background: #e3f2fd;
  color: #0074cc;
}

/* Platinum Card */
.platinum-card {
  border-radius: 16px;
  overflow: hidden;
  padding: 22px;
  color: white;
  position: relative;
  background: linear-gradient(135deg, #d3d7dc 0%, #a0a5ab 30%, #70757a 60%, #1f2326 100%);
  box-shadow: 0 10px 30px rgba(15,15,20,0.25);
  opacity: 0;
  transform: translateY(10px) scale(0.98);
  transition: all 0.6s ease;
}
.platinum-card.show {
  opacity: 1;
  transform: none;
}
.card-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.card-chip {
  width: 52px;
  height: 40px;
  border-radius: 6px;
  background: linear-gradient(180deg,#f2f2f2,#d9d9d9);
}
.card-number {
  font-family: "Courier New", monospace;
  font-size: 1.2rem;
  letter-spacing: 3px;
  margin-top: 14px;
  color: #fff;
}
.card-row {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  font-size: 0.9rem;
}
.card-small {
  font-size: 0.7rem;
  text-transform: uppercase;
  color: #cfd2d4;
}
.btn-card {
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  background: rgba(255,255,255,0.15);
  color: #fff;
  cursor: pointer;
  font-weight: 600;
  transition: 0.3s;
}
.btn-card:hover {
  background: rgba(255,255,255,0.25);
}
.card-actions {
  margin-top: 10px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}
</style>
{% endblock %}
